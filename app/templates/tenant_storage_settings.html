{% extends "base.html" %}

{% block title %}ストレージ連携設定{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>📦 ストレージ連携設定</h2>
    
    <div class="alert alert-info">
        <strong>ℹ️ ストレージ連携について</strong><br>
        顧問先のファイルを保存するための外部ストレージサービスと連携します。<br>
        Dropbox または Google Cloud Storage を選択できます。
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if view.is_connected %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">✅ 連携中: {{ view.provider|upper }}</h5>
        </div>
        <div class="card-body">
            {% if view.provider == 'dropbox' %}
                <p><strong>プロバイダー:</strong> Dropbox</p>
                <p><strong>アクセストークン:</strong> {{ view.dropbox_access_token }}</p>
            {% elif view.provider == 'gcs' %}
                <p><strong>プロバイダー:</strong> Google Cloud Storage</p>
                <p><strong>バケット名:</strong> {{ view.gcs_bucket }}</p>
                <p><strong>サービスアカウント:</strong> {{ view.gcs_service_account_json_masked }}</p>
            {% endif %}
            
            <form method="POST" action="{{ url_for('tenant_storage.disconnect_storage') }}" class="mt-3">
                <button type="submit" class="btn btn-danger" onclick="return confirm('ストレージ連携を解除しますか？')">
                    連携を解除
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">{{ '連携を変更' if view.is_connected else 'ストレージサービスと連携' }}</h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="storageTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dropbox-tab" data-bs-toggle="tab" data-bs-target="#dropbox" type="button" role="tab">
                        Dropbox
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gcs-tab" data-bs-toggle="tab" data-bs-target="#gcs" type="button" role="tab">
                        Google Cloud Storage
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3" id="storageTabContent">
                <!-- Dropbox設定 -->
                <div class="tab-pane fade show active" id="dropbox" role="tabpanel">
                    <h5>Dropbox連携</h5>
                    <p class="text-muted">Dropboxのアクセストークンを入力してください。</p>
                    
                    <div class="alert alert-warning">
                        <strong>⚠️ アクセストークンの取得方法</strong><br>
                        1. <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropbox App Console</a> にアクセス<br>
                        2. 「Create app」をクリック<br>
                        3. Scoped access / Full Dropbox を選択<br>
                        4. アプリ名を入力して作成<br>
                        5. Permissions タブで以下の権限を有効化:<br>
                        &nbsp;&nbsp;- files.content.write<br>
                        &nbsp;&nbsp;- files.content.read<br>
                        &nbsp;&nbsp;- sharing.write<br>
                        6. Settings タブで「Generate access token」をクリック
                    </div>

                    <form method="POST">
                        <input type="hidden" name="provider" value="dropbox">
                        <div class="mb-3">
                            <label for="dropbox_access_token" class="form-label">アクセストークン *</label>
                            <input type="text" class="form-control" id="dropbox_access_token" name="dropbox_access_token" 
                                   placeholder="sl.xxxxxxxxxxxxxxxxxxxxx" required>
                            <small class="form-text text-muted">
                                Dropboxで生成したアクセストークンを入力してください
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary">Dropboxと連携</button>
                    </form>
                </div>

                <!-- Google Cloud Storage設定 -->
                <div class="tab-pane fade" id="gcs" role="tabpanel">
                    <h5>Google Cloud Storage連携</h5>
                    <p class="text-muted">GCSのバケット名とサービスアカウントキーを入力してください。</p>
                    
                    <div class="alert alert-warning">
                        <strong>⚠️ GCS設定の準備</strong><br>
                        1. <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> にアクセス<br>
                        2. プロジェクトを作成または選択<br>
                        3. Cloud Storage APIを有効化<br>
                        4. バケットを作成<br>
                        5. サービスアカウントを作成（ロール: Storage Object Admin）<br>
                        6. サービスアカウントのキー（JSON）をダウンロード
                    </div>

                    <form method="POST">
                        <input type="hidden" name="provider" value="gcs">
                        <div class="mb-3">
                            <label for="gcs_bucket" class="form-label">バケット名 *</label>
                            <input type="text" class="form-control" id="gcs_bucket" name="gcs_bucket" 
                                   placeholder="my-bucket-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="gcs_service_account_json" class="form-label">サービスアカウントキー（JSON） *</label>
                            <textarea class="form-control" id="gcs_service_account_json" name="gcs_service_account_json" 
                                      rows="6" placeholder='{"type": "service_account", ...}' required></textarea>
                            <small class="form-text text-muted">
                                ダウンロードしたJSONファイルの内容をそのまま貼り付けてください
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary">GCSと連携</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('tenant_admin.dashboard') }}" class="btn btn-secondary">← ダッシュボードに戻る</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
